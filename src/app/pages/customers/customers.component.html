<div class="customer-page">
  <!-- Page Title -->
  <div class="page-title">
    <i class="bi bi-people"></i>
    <span> Quản lý khách hàng</span>
  </div>

  <!-- Action Buttons -->
<div class="action-buttons" (clickOutside)="showColumnPanel = false">

  <!-- Button -->
  <div class="column-toggle-wrapper">
    <button class="btn-action btn-green"
            (click)="toggleColumnPanel($event)">
      ☰ Ẩn hiện cột
    </button>

    <!-- PANEL ẨN / HIỆN CỘT -->
    <div class="column-panel" *ngIf="showColumnPanel">
      <label><input type="checkbox" [(ngModel)]="visibleColumns.group"> Nhóm</label>
      <label><input type="checkbox" [(ngModel)]="visibleColumns.code"> Mã</label>
      <label><input type="checkbox" [(ngModel)]="visibleColumns.name"> Tên</label>
      <label><input type="checkbox" [(ngModel)]="visibleColumns.taxCode"> Mã số thuế</label>
      <label><input type="checkbox" [(ngModel)]="visibleColumns.cccd"> CCCD</label>
      <label><input type="checkbox" [(ngModel)]="visibleColumns.phone"> Điện thoại</label>
      <label><input type="checkbox" [(ngModel)]="visibleColumns.address"> Địa chỉ</label>
      <label><input type="checkbox" [(ngModel)]="visibleColumns.email"> Email</label>
    </div>
  </div>

  <button class="btn-action btn-cyan" (click)="createNew()">
    <i class="pi pi-plus-circle"></i> Tạo mới
  </button>

</div>


  <!-- Content Card -->
  <div class="content-card">
     <div class="inner-box">
    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-item">
        <label>Năm</label>
        <select class="form-input" [(ngModel)]="selectedYear">
          <option>2026</option>
        </select>
      </div>

<div class="filter-item">
  <label>Nhóm</label>

  <div class="group-select-wrap">
    <!-- Custom Select Dropdown -->
    <div class="custom-group-select" [class.open]="showGroupDropdown">
      <!-- Header - Click để mở dropdown -->
      <div class="select-header" (click)="toggleGroupDropdown()">
        <span class="selected-value">{{ getSelectedGroupText() }}</span>
        <i class="pi pi-angle-down select-arrow"></i>
            <button class="group-add-btn" type="button" (click)="openGroupModal();$event.stopPropagation()">
                 <i class="pi pi-plus-circle"></i>
            </button>
      </div>
      

      <!-- Dropdown options -->
      <div class="select-options" *ngIf="showGroupDropdown">
        <!-- Option: Tất cả -->
        <div class="select-option" (click)="selectGroup(null)">
          <span class="option-text">Tất cả</span>
        </div>

        <!-- Các option nhóm với icon sửa -->
        <div 
          *ngFor="let group of groups" 
          class="select-option with-edit">
          <span class="option-text" (click)="selectGroup(group.id)">
            {{group.code}} - {{group.name}}
          </span>
          <button 
            class="option-edit-btn" 
            (click)="openEditGroupModal(group, $event)"
            title="Sửa nhóm">
            <i class="pi pi-pencil"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Icon + để thêm nhóm mới -->

  </div>
</div>




      <div class="filter-item">
        <label>Tìm theo</label>
        <select class="form-input" [(ngModel)]="searchType">
          <option value="name">Tên khách hàng</option>
          <option value="taxCode">MST</option>
          <option value="address">Địa chỉ</option>
          <option value="phone">Điện thoại</option>
          <option value="cccd">CCCD</option>
        </select>
      </div>

      <div class="filter-item filter-search">
        <label>&nbsp;</label>
        <input type="text" class="form-input" 
               placeholder="Tìm kiếm ..." 
               [(ngModel)]="searchKeyword"
               (keyup.enter)="applyFilter()">
      </div>

      <div class="filter-item">
        <label>&nbsp;</label>
        <div class="filter-btns">
          <button class="btn-filter" (click)="applyFilter()">Lọc</button>
          <button class="btn-clear" (click)="clearFilter()">Bỏ lọc</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-actions"></th>
            <th *ngIf="visibleColumns.group">Nhóm</th>
            <th *ngIf="visibleColumns.code">Mã</th>
            <th *ngIf="visibleColumns.name">Tên</th>
            <th *ngIf="visibleColumns.taxCode">Mã số thuế</th>
            <th *ngIf="visibleColumns.cccd">Số CCCD</th>
            <th *ngIf="visibleColumns.phone">Điện thoại</th>
            <th *ngIf="visibleColumns.address">Địa chỉ</th>
            <th *ngIf="visibleColumns.email">Email</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let customer of paginatedCustomers">
            <td class="col-actions">
              <button class="icon-btn edit-btn" (click)="viewDetail(customer)">
                <i class="fa-regular fa-pen-to-square"></i>
              </button>
              <button class="icon-btn delete-btn" (click)="deleteCustomer(customer)">
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </td>
            <td *ngIf="visibleColumns.group">{{ customer.group }}</td>
            <td *ngIf="visibleColumns.code">{{ customer.code }}</td>
            <td *ngIf="visibleColumns.name">{{ customer.name }}</td>
            <td *ngIf="visibleColumns.taxCode">{{ customer.taxCode }}</td>
            <td *ngIf="visibleColumns.cccd">{{ customer.cccd }}</td>
            <td *ngIf="visibleColumns.phone">{{ customer.phone }}</td>
            <td *ngIf="visibleColumns.address">{{ customer.address }}</td>
            <td *ngIf="visibleColumns.email">{{customer.email}}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-bar">
      <div class="page-info">
        Từ {{ (currentPage - 1) * pageSize + 1 }} đến {{ Math.min(currentPage * pageSize, totalItems) }} trên tổng {{ totalItems }}
      </div>
      <div class="page-controls">
        <button class="page-btn" [disabled]="currentPage === 1" (click)="goToFirstPage()">
          <i class="fa-solid fa-angles-left"></i>
        </button>
        <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
          <i class="fa-solid fa-angle-left"></i>
        </button>
        
        <button class="page-btn" 
                *ngFor="let page of pageNumbers" 
                [class.active]="page === currentPage"
                (click)="goToPage(page)">
          {{ page }}
        </button>
        
        <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
          <i class="fa-solid fa-angle-right"></i>
        </button>
        <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToLastPage()">
          <i class="fa-solid fa-angles-right"></i>
        </button>
        
        <select class="page-size" [(ngModel)]="pageSize" (change)="changePageSize()">
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
      </div>
    </div>
</div>
  </div>
</div>

<!-- Modal Edit Customer -->
<app-customer-modal
  *ngIf="selectedCustomer"
  [visible]="true"
  [customer]="selectedCustomer"
  (close)="closeModal()"
  (save)="saveCustomer($event)"
  (openGroupModal)="openGroupModalFromCustomer()">
</app-customer-modal>

<!-- Modal Group -->
<app-group-modal
  [show]="showModal"
  [group]="editingGroup"
  [groupType]="'customer'"
  (closeModal)="handleCloseModal()"
  (onSubmit)="handleSubmit($event)"
  (onDelete)="handleDeleteGroup($event)">
</app-group-modal>
